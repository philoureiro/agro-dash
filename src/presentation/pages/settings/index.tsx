import React, { useEffect, useState } from 'react';

import { useAppStore } from '@storage';
import { useThemeMode } from '@theme';

import {
  ActionButton,
  CardDescription,
  CardHeader,
  CardIcon,
  CardTitle,
  Modal,
  ModalActions,
  ModalContent,
  ModalText,
  ModalTitle,
  OptionInfo,
  OptionLabel,
  OptionSubtext,
  SettingOption,
  SettingsCard,
  SettingsContainer,
  SettingsGrid,
  SettingsHeader,
  SettingsSubtitle,
  SettingsTitle,
  StatItem,
  StatLabel,
  StatValue,
  StatsSection,
  ToggleSwitch,
} from './styles';

// üìä COMPONENTE PRINCIPAL
export const Settings: React.FC = () => {
  const { themeMode, toggle: toggleThemeMode } = useThemeMode();
  const isDark = themeMode === 'dark';

  // üéØ HOOKS DO APP STORE
  const { getAllData, clearAllData } = useAppStore();

  // üéØ ESTADOS LOCAIS
  const [compactMode, setCompactMode] = useState(() => {
    return localStorage.getItem('agrodash-compact-mode') === 'true';
  });

  const [animations, setAnimations] = useState(() => {
    return localStorage.getItem('agrodash-animations') !== 'false';
  });

  const [autoSave, setAutoSave] = useState(() => {
    return localStorage.getItem('agrodash-auto-save') !== 'false';
  });

  const [notifications, setNotifications] = useState(() => {
    return localStorage.getItem('agrodash-notifications') !== 'false';
  });

  // Estados de controle
  const [showResetSystemModal, setShowResetSystemModal] = useState(false);
  const [showResetDataModal, setShowResetDataModal] = useState(false);
  const [showResetConfigModal, setShowResetConfigModal] = useState(false);
  const [isResetting, setIsResetting] = useState(false);
  const [isExporting, setIsExporting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Stats mock
  const [totalSessions] = useState(47);
  const [totalTimeSpent] = useState('2h 34m');
  const [activeSettings, setActiveSettings] = useState(3);
  const [lastAccess] = useState('Hoje, 15:42');

  // üìä CALCULA CONFIGURA√á√ïES ATIVAS
  useEffect(() => {
    const count = [
      isDark ? 1 : 0,
      compactMode ? 1 : 0,
      animations ? 1 : 0,
      autoSave ? 1 : 0,
      notifications ? 1 : 0,
    ].reduce((sum, val) => sum + val, 0);

    setActiveSettings(count);
  }, [isDark, compactMode, animations, autoSave, notifications]);

  // üé® APLICA MUDAN√áAS CSS
  useEffect(() => {
    // Anima√ß√µes globais
    document.documentElement.style.setProperty('--animations-enabled', animations ? '1' : '0');

    // Salva no localStorage
    localStorage.setItem('agrodash-animations', animations.toString());
  }, [animations]);

  // üéØ APLICA MODO COMPACTO
  useEffect(() => {
    document.documentElement.classList.toggle('compact-mode', compactMode);
    localStorage.setItem('agrodash-compact-mode', compactMode.toString());
  }, [compactMode]);

  // üíæ SALVA OUTRAS CONFIGURA√á√ïES
  useEffect(() => {
    localStorage.setItem('agrodash-auto-save', autoSave.toString());
  }, [autoSave]);

  useEffect(() => {
    localStorage.setItem('agrodash-notifications', notifications.toString());
  }, [notifications]);

  // üé® HANDLERS DE TOGGLE
  const handleThemeToggle = () => {
    toggleThemeMode();
  };

  const handleAutoSaveToggle = () => {
    setAutoSave((prev) => !prev);
  };

  const handleNotificationsToggle = () => {
    setNotifications((prev) => !prev);
  };

  // üì§ BACKUP COMPLETO DOS DADOS (FAZENDAS/PRODUTORES/CULTURAS)
  const handleExportData = async () => {
    try {
      setIsExporting(true);

      const allData = getAllData();

      const exportData = {
        timestamp: new Date().toISOString(),
        version: '2.0.0',
        type: 'complete-data',
        data: {
          producers: allData.producers,
          farms: allData.farms,
          crops: allData.crops,
          // Outros dados do sistema
          dashboardCache: localStorage.getItem('agrodash-dashboard-cache'),
          userPreferences: localStorage.getItem('agrodash-user-preferences'),
        },
        stats: {
          totalProducers: allData.producers.length,
          totalFarms: allData.farms.length,
          totalCrops: allData.crops.length,
        },
      };

      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `agrodash-dados-completos-${new Date().toISOString().slice(0, 10)}.json`;
      link.click();

      URL.revokeObjectURL(url);

      alert('‚úÖ Backup completo dos dados exportado com sucesso!');
    } catch (error) {
      console.error('Erro no export:', error);
      setError('Erro ao exportar dados completos');
    } finally {
      setIsExporting(false);
    }
  };

  // ‚öôÔ∏è BACKUP APENAS DAS CONFIGURA√á√ïES
  const handleExportSettings = async () => {
    try {
      setIsExporting(true);

      const exportData = {
        timestamp: new Date().toISOString(),
        version: '2.0.0',
        type: 'settings-only',
        settings: {
          theme: isDark ? 'dark' : 'light',
          compactMode,
          animations,
          autoSave,
          notifications,
        },
        stats: {
          totalSessions,
          totalTimeSpent,
          activeSettings,
          lastAccess,
        },
      };

      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `agrodash-configuracoes-${new Date().toISOString().slice(0, 10)}.json`;
      link.click();

      URL.revokeObjectURL(url);

      alert('‚úÖ Configura√ß√µes exportadas com sucesso!');
    } catch (error) {
      console.error('Erro no export:', error);
      setError('Erro ao exportar configura√ß√µes');
    } finally {
      setIsExporting(false);
    }
  };

  // üîÑ RESET COMPLETO DO SISTEMA (TUDO)
  const handleResetSystem = async () => {
    setIsResetting(true);

    try {
      await new Promise((resolve) => setTimeout(resolve, 2000));

      // Limpa TUDO
      localStorage.clear();
      clearAllData();

      // Reseta configura√ß√µes visuais

      setAutoSave(true);
      setNotifications(true);

      setIsResetting(false);
      setShowResetSystemModal(false);

      alert('‚úÖ Sistema completamente restaurado!\nTudo foi removido e resetado.');

      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } catch (error) {
      console.error('Erro ao resetar sistema:', error);
      setError('Erro ao restaurar sistema');
      setIsResetting(false);
    }
  };

  // üìä RESET APENAS DOS DADOS (FAZENDAS/PRODUTORES/CULTURAS)
  const handleResetData = async () => {
    setIsResetting(true);

    try {
      await new Promise((resolve) => setTimeout(resolve, 1500));

      // Limpa apenas dados do neg√≥cio
      clearAllData();

      // Remove dados espec√≠ficos do localStorage
      const dataKeys = [
        'agro-dash-producers',
        'agro-dash-farms',
        'agro-dash-crops',
        'agro-dash-app',
        'agrodash-dashboard-cache',
        'agrodash-user-preferences',
      ];

      dataKeys.forEach((key) => {
        localStorage.removeItem(key);
      });

      setIsResetting(false);
      setShowResetDataModal(false);

      alert('‚úÖ Dados do sistema removidos!\nFazendas, produtores e culturas foram resetados.');
    } catch (error) {
      console.error('Erro ao resetar dados:', error);
      setError('Erro ao restaurar dados');
      setIsResetting(false);
    }
  };

  // ‚öôÔ∏è RESET APENAS DAS CONFIGURA√á√ïES
  const handleResetConfig = async () => {
    setIsResetting(true);

    try {
      await new Promise((resolve) => setTimeout(resolve, 1000));

      // Remove apenas configura√ß√µes
      const configKeys = [
        'agrodash-compact-mode',
        'agrodash-animations',
        'agrodash-auto-save',
        'agrodash-notifications',
        'agro-dash-app',
        'theme-mode',
      ];

      configKeys.forEach((key) => {
        localStorage.removeItem(key);
      });

      // Reseta configura√ß√µes visuais
      setCompactMode(false);
      setAnimations(true);
      setAutoSave(true);
      setNotifications(true);

      // Remove classes CSS
      document.documentElement.classList.remove('compact-mode');
      document.documentElement.style.setProperty('--animations-enabled', '1');

      setIsResetting(false);
      setShowResetConfigModal(false);

      alert('‚úÖ Configura√ß√µes restauradas!\nTodas as prefer√™ncias voltaram ao padr√£o.');
    } catch (error) {
      console.error('Erro ao resetar configura√ß√µes:', error);
      setError('Erro ao restaurar configura√ß√µes');
      setIsResetting(false);
    }
  };

  // üö® HANDLER DE ERRO
  const handleErrorDismiss = () => {
    setError(null);
  };

  return (
    <SettingsContainer isDark={isDark}>
      {/* ‚ö†Ô∏è ALERTA DE ERRO */}
      {error && (
        <div
          style={{
            position: 'fixed',
            top: '20px',
            right: '20px',
            background: '#ef4444',
            color: 'white',
            padding: '12px 20px',
            borderRadius: '8px',
            zIndex: 1000,
            display: 'flex',
            alignItems: 'center',
            gap: '10px',
          }}
        >
          <span>‚ùå {error}</span>
          <button
            onClick={handleErrorDismiss}
            style={{
              background: 'none',
              border: 'none',
              color: 'white',
              cursor: 'pointer',
              fontSize: '16px',
            }}
          >
            ‚úï
          </button>
        </div>
      )}

      {/* üèÜ HEADER */}
      <SettingsHeader>
        <SettingsTitle isDark={isDark}>‚öôÔ∏è Configura√ß√µes</SettingsTitle>
        <SettingsSubtitle isDark={isDark}>
          Personalize sua experi√™ncia no AgroDash e gerencie suas prefer√™ncias
        </SettingsSubtitle>
      </SettingsHeader>

      {/* üé® GRID DE CONFIGURA√á√ïES */}
      <SettingsGrid>
        {/* üé® APAR√äNCIA */}
        <SettingsCard isDark={isDark} delay={0}>
          <CardHeader>
            <CardIcon isDark={isDark}>üé®</CardIcon>
            <div>
              <CardTitle isDark={isDark}>Apar√™ncia</CardTitle>
              <CardDescription isDark={isDark}>
                Customize a interface visual do sistema
              </CardDescription>
            </div>
          </CardHeader>

          <SettingOption delay={100}>
            <OptionInfo>
              <OptionLabel isDark={isDark}>{`Tema ${isDark ? 'Escuro' : 'Claro'}`}</OptionLabel>
              <OptionSubtext isDark={isDark}>
                {`Voltar para o modo ${isDark ? 'Claro' : 'Escuro'} para facilitar leitura`}
              </OptionSubtext>
            </OptionInfo>
            <ToggleSwitch isActive={isDark} isDark={isDark} onClick={handleThemeToggle} />
          </SettingOption>
        </SettingsCard>

        {/* üîî SISTEMA */}
        <SettingsCard isDark={isDark} delay={100}>
          <CardHeader>
            <CardIcon isDark={isDark}>üîî</CardIcon>
            <div>
              <CardTitle isDark={isDark}>Sistema</CardTitle>
              <CardDescription isDark={isDark}>
                Configura√ß√µes de funcionamento e performance
              </CardDescription>
            </div>
          </CardHeader>

          <SettingOption delay={100}>
            <OptionInfo>
              <OptionLabel isDark={isDark}>Salvamento Autom√°tico</OptionLabel>
              <OptionSubtext isDark={isDark}>
                Salva altera√ß√µes automaticamente conforme voc√™ trabalha
              </OptionSubtext>
            </OptionInfo>
            <ToggleSwitch isActive={autoSave} isDark={isDark} onClick={handleAutoSaveToggle} />
          </SettingOption>

          <SettingOption delay={200}>
            <OptionInfo>
              <OptionLabel isDark={isDark}>Notifica√ß√µes</OptionLabel>
              <OptionSubtext isDark={isDark}>
                Receba alertas sobre atualiza√ß√µes importantes
              </OptionSubtext>
            </OptionInfo>
            <ToggleSwitch
              isActive={notifications}
              isDark={isDark}
              onClick={handleNotificationsToggle}
            />
          </SettingOption>
        </SettingsCard>

        {/* üìä ESTAT√çSTICAS */}
        <SettingsCard isDark={isDark} delay={200}>
          <CardHeader>
            <CardIcon isDark={isDark}>üìä</CardIcon>
            <div>
              <CardTitle isDark={isDark}>Estat√≠sticas de Uso</CardTitle>
              <CardDescription isDark={isDark}>Acompanhe seu uso do AgroDash</CardDescription>
            </div>
          </CardHeader>

          <StatsSection>
            <StatItem isDark={isDark} delay={100}>
              <StatValue isDark={isDark}>{totalSessions}</StatValue>
              <StatLabel isDark={isDark}>Sess√µes</StatLabel>
            </StatItem>

            <StatItem isDark={isDark} delay={200}>
              <StatValue isDark={isDark}>{totalTimeSpent}</StatValue>
              <StatLabel isDark={isDark}>Tempo Total</StatLabel>
            </StatItem>

            <StatItem isDark={isDark} delay={300}>
              <StatValue isDark={isDark}>{activeSettings}</StatValue>
              <StatLabel isDark={isDark}>Config. Ativas</StatLabel>
            </StatItem>
          </StatsSection>

          <SettingOption delay={400}>
            <OptionInfo>
              <OptionLabel isDark={isDark}>√öltimo Acesso</OptionLabel>
              <OptionSubtext isDark={isDark}>{lastAccess}</OptionSubtext>
            </OptionInfo>
          </SettingOption>
        </SettingsCard>

        {/* üì¶ BACKUP DE DADOS */}
        <SettingsCard isDark={isDark} delay={300}>
          <CardHeader>
            <CardIcon isDark={isDark}>üì¶</CardIcon>
            <div>
              <CardTitle isDark={isDark}>Backup dos Dados</CardTitle>
              <CardDescription isDark={isDark}>
                Exporta fazendas, produtores, culturas e dados do sistema
              </CardDescription>
            </div>
          </CardHeader>

          <SettingOption delay={100}>
            <OptionInfo>
              <OptionLabel isDark={isDark}>Dados Completos</OptionLabel>
              <OptionSubtext isDark={isDark}>
                Fazendas, produtores, culturas e cache do sistema
              </OptionSubtext>
            </OptionInfo>
            <ActionButton
              variant="secondary"
              isDark={isDark}
              size="small"
              onClick={handleExportData}
              disabled={isExporting}
            >
              üì¶ Exportar Dados
            </ActionButton>
          </SettingOption>
        </SettingsCard>

        {/* ‚öôÔ∏è BACKUP DE CONFIGURA√á√ïES */}
        <SettingsCard isDark={isDark} delay={400}>
          <CardHeader>
            <CardIcon isDark={isDark}>‚öôÔ∏è</CardIcon>
            <div>
              <CardTitle isDark={isDark}>Backup das Configura√ß√µes</CardTitle>
              <CardDescription isDark={isDark}>
                Exporta apenas tema, prefer√™ncias e estat√≠sticas
              </CardDescription>
            </div>
          </CardHeader>

          <SettingOption delay={100}>
            <OptionInfo>
              <OptionLabel isDark={isDark}>Configura√ß√µes e Stats</OptionLabel>
              <OptionSubtext isDark={isDark}>
                Tema, modo compacto, anima√ß√µes e estat√≠sticas
              </OptionSubtext>
            </OptionInfo>
            <ActionButton
              variant="secondary"
              isDark={isDark}
              size="small"
              onClick={handleExportSettings}
              disabled={isExporting}
            >
              ‚öôÔ∏è Exportar Config
            </ActionButton>
          </SettingOption>
        </SettingsCard>

        {/* üîÑ RESTAURAR SISTEMA */}
        <SettingsCard isDark={isDark} delay={500}>
          <CardHeader>
            <CardIcon isDark={isDark}>üîÑ</CardIcon>
            <div>
              <CardTitle isDark={isDark}>Restaurar Sistema</CardTitle>
              <CardDescription isDark={isDark}>
                Op√ß√µes de reset individuais ou completo
              </CardDescription>
            </div>
          </CardHeader>

          <SettingOption delay={100}>
            <OptionInfo>
              <OptionLabel isDark={isDark}>Reset Completo</OptionLabel>
              <OptionSubtext isDark={isDark}>
                Remove TUDO: dados + configura√ß√µes + cache
              </OptionSubtext>
            </OptionInfo>
            <ActionButton
              variant="danger"
              isDark={isDark}
              size="small"
              onClick={() => setShowResetSystemModal(true)}
              disabled={isResetting}
            >
              üóëÔ∏è Reset Total
            </ActionButton>
          </SettingOption>

          <SettingOption delay={200}>
            <OptionInfo>
              <OptionLabel isDark={isDark}>Reset dos Dados</OptionLabel>
              <OptionSubtext isDark={isDark}>
                Remove apenas fazendas, produtores e culturas
              </OptionSubtext>
            </OptionInfo>
            <ActionButton
              variant="danger"
              isDark={isDark}
              size="small"
              onClick={() => setShowResetDataModal(true)}
              disabled={isResetting}
            >
              üìä Reset Dados
            </ActionButton>
          </SettingOption>

          <SettingOption delay={300}>
            <OptionInfo>
              <OptionLabel isDark={isDark}>Reset das Configura√ß√µes</OptionLabel>
              <OptionSubtext isDark={isDark}>Volta apenas as prefer√™ncias ao padr√£o</OptionSubtext>
            </OptionInfo>
            <ActionButton
              variant="danger"
              isDark={isDark}
              size="small"
              onClick={() => setShowResetConfigModal(true)}
              disabled={isResetting}
            >
              ‚öôÔ∏è Reset Config
            </ActionButton>
          </SettingOption>
        </SettingsCard>
      </SettingsGrid>

      {/* üéØ MODAL RESET SISTEMA COMPLETO */}
      <Modal isOpen={showResetSystemModal} data-open={showResetSystemModal}>
        <ModalContent isDark={isDark}>
          <ModalTitle isDark={isDark}>üóëÔ∏è Reset Completo do Sistema</ModalTitle>
          <ModalText isDark={isDark}>
            Esta a√ß√£o ir√° remover <strong>ABSOLUTAMENTE TUDO</strong>:
            <br />
            <br />
            ‚Ä¢ üìä Todas as fazendas, produtores e culturas
            <br />
            ‚Ä¢ ‚öôÔ∏è Todas as configura√ß√µes e prefer√™ncias
            <br />
            ‚Ä¢ üìà Todas as estat√≠sticas de uso
            <br />
            ‚Ä¢ üóÇÔ∏è Todo o cache e dados tempor√°rios
            <br />
            <br />
            <strong>‚ö†Ô∏è O sistema ser√° completamente reiniciado!</strong>
          </ModalText>
          <ModalActions>
            <ActionButton
              variant="secondary"
              isDark={isDark}
              onClick={() => setShowResetSystemModal(false)}
              disabled={isResetting}
            >
              ‚ùå Cancelar
            </ActionButton>
            <ActionButton
              variant="danger"
              isDark={isDark}
              onClick={handleResetSystem}
              disabled={isResetting}
            >
              {isResetting ? 'üîÑ Resetando...' : '‚úÖ Reset Total'}
            </ActionButton>
          </ModalActions>
        </ModalContent>
      </Modal>

      {/* üìä MODAL RESET DADOS */}
      <Modal isOpen={showResetDataModal} data-open={showResetDataModal}>
        <ModalContent isDark={isDark}>
          <ModalTitle isDark={isDark}>üìä Reset dos Dados</ModalTitle>
          <ModalText isDark={isDark}>
            Esta a√ß√£o ir√° remover apenas os <strong>dados do neg√≥cio</strong>:
            <br />
            <br />
            ‚Ä¢ üè° Todas as fazendas cadastradas
            <br />
            ‚Ä¢ üë• Todos os produtores
            <br />
            ‚Ä¢ üåæ Todas as culturas
            <br />
            ‚Ä¢ üìã Cache do dashboard
            <br />
            <br />
            <strong>‚úÖ Suas configura√ß√µes ser√£o mantidas!</strong>
          </ModalText>
          <ModalActions>
            <ActionButton
              variant="secondary"
              isDark={isDark}
              onClick={() => setShowResetDataModal(false)}
              disabled={isResetting}
            >
              ‚ùå Cancelar
            </ActionButton>
            <ActionButton
              variant="danger"
              isDark={isDark}
              onClick={handleResetData}
              disabled={isResetting}
            >
              {isResetting ? 'üîÑ Removendo...' : '‚úÖ Reset Dados'}
            </ActionButton>
          </ModalActions>
        </ModalContent>
      </Modal>

      {/* ‚öôÔ∏è MODAL RESET CONFIGURA√á√ïES */}
      <Modal isOpen={showResetConfigModal} data-open={showResetConfigModal}>
        <ModalContent isDark={isDark}>
          <ModalTitle isDark={isDark}>‚öôÔ∏è Reset das Configura√ß√µes</ModalTitle>
          <ModalText isDark={isDark}>
            Esta a√ß√£o ir√° resetar apenas as <strong>configura√ß√µes</strong>:
            <br />
            <br />
            ‚Ä¢ üé® Tema volta para o padr√£o do dispositivo
            <br />
            ‚Ä¢ üì± Modo compacto desativado
            <br />
            ‚Ä¢ ‚ú® Anima√ß√µes ativadas
            <br />
            ‚Ä¢ üíæ Auto-save ativado
            <br />
            ‚Ä¢ üîî Notifica√ß√µes ativadas
            <br />
            <br />
            <strong>‚úÖ Seus dados ser√£o mantidos!</strong>
          </ModalText>
          <ModalActions>
            <ActionButton
              variant="secondary"
              isDark={isDark}
              onClick={() => setShowResetConfigModal(false)}
              disabled={isResetting}
            >
              ‚ùå Cancelar
            </ActionButton>
            <ActionButton
              variant="danger"
              isDark={isDark}
              onClick={handleResetConfig}
              disabled={isResetting}
            >
              {isResetting ? 'üîÑ Resetando...' : '‚úÖ Reset Config'}
            </ActionButton>
          </ModalActions>
        </ModalContent>
      </Modal>

      {/* üîÑ OVERLAY DE LOADING */}
      {(isExporting || isResetting) && (
        <div
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.7)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 9999,
            color: 'white',
            fontSize: '18px',
            fontWeight: 'bold',
          }}
        >
          <div style={{ textAlign: 'center' }}>
            <div style={{ fontSize: '48px', marginBottom: '20px' }}>
              {isResetting ? 'üîÑ' : 'üì§'}
            </div>
            <div>{isResetting ? 'Processando reset...' : 'Exportando dados...'}</div>
          </div>
        </div>
      )}
    </SettingsContainer>
  );
};
